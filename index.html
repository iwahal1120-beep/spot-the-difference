<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>World Challenge! Spot the Difference 3</title>
<style>
    :root { --gold: #d4af37; --bg: #050505; }
    body { 
        margin: 0; padding: 0; background-color: var(--bg); color: var(--gold);
        font-family: 'Helvetica Neue', Arial, sans-serif; overflow: hidden; touch-action: none;
    }
    /* ヘッダーエリア：イラストに被らないよう高さを固定 */
    .header { 
        height: 120px; background: linear-gradient(to bottom, #222, #000);
        border-bottom: 2px solid var(--gold); display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .main-title { font-size: 18px; font-weight: bold; color: #fff; margin: 0; }
    .sub-title { font-size: 12px; letter-spacing: 2px; }
    #stg-name { color: #00e5ff; font-weight: bold; margin-top: 5px; }
    .status-bar { display: flex; gap: 40px; font-size: 20px; margin-top: 10px; font-weight: bold; }
    #timer { color: #ff3b3b; }
    #counter { color: #00ff00; }

    /* ゲームエリア：左右に並べる */
    .game-container { 
        display: flex; width: 100vw; height: calc(100vh - 120px); 
        justify-content: center; align-items: center; gap: 5px; background: #000;
    }
    canvas { 
        width: 48%; max-height: 90%; border: 2px solid var(--gold); background: #111;
        object-fit: contain; cursor: crosshair;
    }

    /* クリア後のモーダル：イラストの上に被せる（終了時のみ） */
    .modal { 
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;
    }
    .modal-content {
        background: #fff; color: #333; padding: 30px; border-radius: 15px;
        width: 85%; max-width: 400px; text-align: center; border: 5px solid var(--gold);
    }
    .qr-img { width: 200px; height: 200px; margin: 15px 0; border: 1px solid #ccc; }
    .btn { 
        display: block; width: 100%; padding: 15px; margin-top: 10px; border: none;
        border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-decoration: none;
    }
    .btn-pay { background: #ff0033; color: white; }
    .btn-retry { background: #666; color: white; }
</style>
</head>
<body>

<div class="header">
    <div class="sub-title">WORLD CHALLENGE! SPOT THE DIFFERENCE</div>
    <div class="main-title">世界で挑戦！間違い探し３</div>
    <div id="stg-name">Loading...</div>
    <div class="status-bar">
        <div>TIME: <span id="timer">45</span></div>
        <div>FOUND: <span id="counter">0</span>/3</div>
    </div>
</div>

<div class="game-container">
    <canvas id="canvasL"></canvas>
    <canvas id="canvasR"></canvas>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <h2 style="color:#d44d5c; margin:0;">CONGRATULATIONS!</h2>
        <p>全5ステージクリア！素晴らしい集中力です！</p>
        <p style="font-size:13px; color:#666;">もし楽しんでいただけたら、制作活動を支援していただけると励みになります。</p>
        <img src="paypay-qr.png" alt="PayPay QR" class="qr-img">
        <a href="https://qr.paypay.ne.jp/p2p01_nSoMCZ93V9DzYia0" target="_blank" class="btn btn-pay">PayPayで支援を送る</a>
        <button onclick="location.reload()" class="btn btn-retry">もう一度遊ぶ</button>
    </div>
</div>

<script>
const stages = [
    {id: 1014, name: "STAGE 1: London"},
    {id: 1033, name: "STAGE 2: Paris"},
    {id: 1029, name: "STAGE 3: New York"},
    {id: 1044, name: "STAGE 4: Tokyo"},
    {id: 1048, name: "STAGE 5: Venice"}
];

let currentStage = 0;
let foundCount = 0;
let timeLeft = 45;
let isPlaying = false;
let diffSpots = [];

const cL = document.getElementById('canvasL');
const cR = document.getElementById('canvasR');
const ctxL = cL.getContext('2d');
const ctxR = cR.getContext('2d');

function initStage() {
    isPlaying = false;
    foundCount = 0;
    timeLeft = 45;
    document.getElementById('counter').innerText = "0";
    document.getElementById('stg-name').innerText = stages[currentStage].name;
    
    const img = new Image();
    img.crossOrigin = "anonymous";
    // 解像度を上げて鮮明に
    img.src = `https://picsum.photos/id/${stages[currentStage].id}/800/1200`;
    
    img.onload = () => {
        cL.width = cR.width = 400;
        cL.height = cR.height = 600;
        
        // 左右に同じ画像を描画
        ctxL.drawImage(img, 0, 0, 400, 600);
        ctxR.drawImage(img, 0, 0, 400, 600);
        
        // 間違い箇所を3つランダム生成
        diffSpots = [];
        for(let i=0; i<3; i++) {
            let spot = {
                x: 50 + Math.random() * 300,
                y: 50 + Math.random() * 500,
                found: false
            };
            diffSpots.push(spot);
            
            // 右側の画像に「間違い」を加工（色反転や加工）
            applyDifference(ctxR, spot.x, spot.y);
        }
        isPlaying = true;
    };
}

function applyDifference(ctx, x, y) {
    ctx.save();
    ctx.beginPath();
    ctx.arc(x, y, 30, 0, Math.PI * 2);
    ctx.clip();
    // 領域を少しずらすか、反転させて「間違い」を作る
    ctx.translate(x, y);
    ctx.scale(-1, 1);
    ctx.drawImage(cL, -x, -y);
    ctx.restore();
}

function checkClick(e, canvas) {
    if(!isPlaying) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    
    // キャンバス内座標に変換
    const scaleX = 400 / rect.width;
    const scaleY = 600 / rect.height;
    const clickX = x * scaleX;
    const clickY = y * scaleY;

    diffSpots.forEach(spot => {
        if(!spot.found) {
            const dist = Math.sqrt((clickX - spot.x)**2 + (clickY - spot.y)**2);
            if(dist < 40) {
                spot.found = true;
                foundCount++;
                drawCircle(spot.x, spot.y);
                document.getElementById('counter').innerText = foundCount;
                
                if(foundCount === 3) {
                    isPlaying = false;
                    setTimeout(nextStage, 1000);
                }
            }
        }
    });
}

function drawCircle(x, y) {
    [ctxL, ctxR].forEach(ctx => {
        ctx.strokeStyle = "#00ff00";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(x, y, 35, 0, Math.PI * 2);
        ctx.stroke();
    });
}

function nextStage() {
    currentStage++;
    if(currentStage < stages.length) {
        initStage();
    } else {
        document.getElementById('modal').style.display = 'flex';
    }
}

// タイマー処理
setInterval(() => {
    if(isPlaying && timeLeft > 0) {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if(timeLeft === 0) {
            alert("TIME UP! 次のステージへ");
            nextStage();
        }
    }
}, 1000);

// イベント登録
[cL, cR].forEach(canvas => {
    canvas.addEventListener('mousedown', (e) => checkClick(e, canvas));
    canvas.addEventListener('touchstart', (e) => {
        checkClick(e, canvas);
        e.preventDefault();
    }, {passive: false});
});

initStage();
</script>
</body>
</html>
